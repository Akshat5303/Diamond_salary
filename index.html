<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CVD Diamond Manager Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0056b3">
    <link rel="apple-touch-icon" href="diamond-logo-v2.png">
    <style>
        :root {
            /* --- COLORS --- */
            --bg-color: #f4f7f6;
            --container-bg: #ffffff;
            --text-color: #333333;
            --primary: #0056b3;
            --secondary: #17a2b8;
            --border: #ddd;
            --input-bg: #ffffff;
            --table-header: #0056b3;
            --row-even: #f9f9f9;
            --modal-bg: white;
            --shadow: rgba(0,0,0,0.1);
            --btn-bg: #f8f9fa;
            /* Highlights */
            --comm-highlight: #fff9c4; 
            --fancy-highlight: #f8d7da; 
            --highlight-text: #333;
        }

        body.dark-mode {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --primary: #4dabf7;
            --secondary: #1aa1b8;
            --border: #333;
            --input-bg: #2d2d2d;
            --table-header: #212529;
            --row-even: #252525;
            --modal-bg: #1e1e1e;
            --shadow: rgba(0,0,0,0.5);
            --btn-bg: #2d2d2d;
            --comm-highlight: #4a4a20; 
            --fancy-highlight: #4a2025; 
            --highlight-text: #fff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 10px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- PROFESSIONAL SPLASH SCREEN (V10) --- */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Premium Deep Blue Radial Gradient */
            background: radial-gradient(circle at center, #0f5abd 0%, #002a5c 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            transition: opacity 0.8s ease-out, visibility 0.8s;
        }

        /* Glowing Diamond Logo */
        .splash-logo {
            font-size: 5.5rem;
            margin-bottom: 15px;
            /* Gold/White Gradient Text for the Diamond */
            background: linear-gradient(135deg, #ffffff 30%, #89c4f4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            /* Soft Glow Effect */
            filter: drop-shadow(0 0 25px rgba(137, 196, 244, 0.5));
            animation: float-diamond 3s ease-in-out infinite;
        }

        .splash-title {
            font-size: 2.2rem;
            font-weight: 800;
            letter-spacing: 2px; /* Professional spacing */
            text-transform: uppercase;
            margin-bottom: 5px;
            text-shadow: 0 4px 10px rgba(0,0,0,0.3);
            background: linear-gradient(to right, #ffffff, #e0e0e0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .splash-subtitle {
            font-size: 0.9rem;
            font-weight: 500;
            opacity: 0.7;
            letter-spacing: 4px; /* Cinematic subtitle spacing */
            text-transform: uppercase;
            margin-bottom: 50px;
        }

        /* Sleek Loading Bar instead of Spinner */
        .loading-container {
            width: 180px;
            height: 4px;
            background-color: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .loading-bar {
            width: 50%;
            height: 100%;
            background-color: #4dabf7; /* Bright Blue */
            position: absolute;
            border-radius: 10px;
            animation: load-slide 1.5s infinite ease-in-out;
            box-shadow: 0 0 10px #4dabf7;
        }

        .splash-footer {
            position: absolute;
            bottom: 30px;
            font-size: 0.75rem;
            opacity: 0.5;
            letter-spacing: 1px;
            font-family: monospace;
        }

        /* Animations */
        @keyframes float-diamond {
            0%, 100% { transform: translateY(0) scale(1); filter: drop-shadow(0 0 25px rgba(137, 196, 244, 0.5)); }
            50% { transform: translateY(-10px) scale(1.05); filter: drop-shadow(0 0 40px rgba(137, 196, 244, 0.8)); }
        }

        @keyframes load-slide {
            0% { left: -50%; }
            100% { left: 100%; }
        }

        /* --- MAIN CONTAINER --- */
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--container-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px var(--shadow);
            flex: 1;
            border: 1px solid var(--border);
            position: relative;
            width: 100%;
            box-sizing: border-box;
        }

        /* --- HEADER --- */
        .card-header-actions {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            margin-bottom: 15px;
        }
        .header-right { display: flex; justify-content: flex-end; gap: 10px; }

        .icon-btn {
            background-color: var(--btn-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-color);
            transition: all 0.2s ease;
            display: flex; align-items: center; justify-content: center;
            min-width: 45px; height: 45px;
        }
        .icon-btn:hover { background-color: var(--primary); color: white; border-color: var(--primary); }

        .type-btn {
            background-color: var(--input-bg);
            border: 2px solid var(--primary);
            color: var(--primary);
            font-weight: bold;
            font-size: 0.9rem;
            padding: 8px 25px;
            border-radius: 20px;
            display: flex; align-items: center; gap: 8px; cursor: pointer; justify-content: center;
            white-space: nowrap;
        }
        .type-btn:hover { background-color: var(--primary); color: white; }

        h1 {
            text-align: center; color: var(--primary); margin-top: 0; margin-bottom: 20px;
            border-bottom: 2px solid var(--border); padding-bottom: 10px; font-size: 1.5rem;
        }

        /* --- INPUT FORM --- */
        .input-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px; margin-bottom: 20px; background: var(--row-even);
            padding: 15px; border-radius: 8px; border: 1px solid var(--border);
        }
        .form-group { display: flex; flex-direction: column; }
        label { font-size: 0.9em; font-weight: bold; margin-bottom: 5px; opacity: 0.8; }
        input, select {
            padding: 12px; border: 1px solid var(--border); border-radius: 6px;
            font-size: 16px; background-color: var(--input-bg); color: var(--text-color);
            width: 100%; box-sizing: border-box;
        }
        
        /* Report Grid */
        .report-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px; margin-bottom: 20px; background: var(--row-even);
            padding: 15px; border-radius: 8px; border: 1px solid var(--border);
        }

        /* --- ACTION GROUP --- */
        .action-group {
            grid-column: 1 / -1;
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap; 
        }

        .add-btn {
            background-color: var(--primary); color: white; border: none;
            padding: 12px; border-radius: 6px; font-size: 0.95rem; cursor: pointer;
            font-weight: bold; flex: 1; min-width: 100px;
        }
        
        .report-view-btn {
            background-color: var(--secondary); color: white; border: none;
            padding: 12px; border-radius: 6px; font-size: 0.95rem; cursor: pointer;
            font-weight: bold; flex: 1; min-width: 100px;
        }
        
        /* NEW SUMMARY BUTTON */
        .summary-btn {
            background-color: #20c997; color: white; border: none;
            padding: 12px; border-radius: 6px; font-size: 0.95rem; cursor: pointer;
            font-weight: bold; flex: 1; min-width: 100px;
        }

        /* ADVANCE & BANK BUTTONS */
        .advance-btn {
            background-color: #ffc107; color: #333; border: none;
            padding: 12px; border-radius: 6px; font-size: 0.95rem; cursor: pointer;
            font-weight: bold; flex: 1; min-width: 100px;
        }
        
        .bank-btn {
            background-color: #6f42c1; color: white; border: none;
            padding: 12px; border-radius: 6px; font-size: 0.95rem; cursor: pointer;
            font-weight: bold; flex: 1; min-width: 100px;
        }

        /* --- TABLE --- */
        .table-container {
            overflow-x: auto; margin-top: 20px; max-height: 400px;
            overflow-y: auto; border: 1px solid var(--border); border-radius: 5px;
            -webkit-overflow-scrolling: touch; 
        }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); color: var(--text-color); }
        th { background-color: var(--table-header); color: white; position: sticky; top: 0; z-index: 10; font-weight: 600; letter-spacing: 0.5px;}
        
        tr:nth-child(even) { background-color: var(--row-even); }
        tr:hover { background-color: rgba(0,0,0,0.05); }
        
        tr.commercial-row { background-color: var(--comm-highlight) !important; color: var(--highlight-text); }
        tr.fancy-row { background-color: var(--fancy-highlight) !important; color: var(--highlight-text); }

        .total-section {
            margin-top: 20px; display: flex; justify-content: space-between;
            align-items: center; background: var(--row-even); padding: 15px;
            border-radius: 5px; border: 1px solid var(--border);
        }
        .grand-total { font-size: 1.3rem; font-weight: bold; color: var(--primary); }

        /* --- REPORT VIEW --- */
        #workerReportView { display: none; }
        .report-header { display: flex; align-items: center; margin-bottom: 15px; justify-content: space-between; }
        .back-btn {
            background: transparent; border: 1px solid var(--border);
            padding: 8px 15px; border-radius: 6px; cursor: pointer;
            color: var(--text-color); font-weight: bold; display: flex; align-items: center; gap: 5px;
        }
        .back-btn:hover { background: var(--row-even); }

        /* --- BUTTONS --- */
        .report-panel { margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; flex-wrap: wrap; }
        .action-btn-shared { border: none; border-radius: 6px; padding: 14px 20px; font-weight: bold; cursor: pointer; flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .clear-btn { background-color: transparent; color: #dc3545; border: 1px solid #dc3545; }
        .csv-btn { background-color: #007bff; color: white; }
        .print-btn { background-color: #28a745; color: white; }
        .restore-btn { background-color: #6c757d; color: white; } 
        .delete-btn { background-color: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        .footer { text-align: center; margin-top: 40px; padding: 10px; opacity: 0.6; font-size: 0.8rem; border-top: 1px solid var(--border); }

        /* --- MODALS FIXED LAYOUT --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 2000; padding: 20px; box-sizing: border-box; }
        
        .modal-content { 
            background-color: var(--modal-bg); 
            border-radius: 12px; 
            width: 100%; 
            max-width: 500px; 
            max-height: 85vh; 
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }
        
        /* WIDER MODAL FOR SUMMARY */
        .modal-content.wide-modal { max-width: 800px; }

        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 20px 10px 20px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .modal-actions { padding: 15px 20px 20px 20px; display: flex; flex-direction: column; gap: 10px; border-top: 1px solid var(--border); flex-shrink: 0; background: var(--modal-bg); }
        
        .modal-scrollable-body {
            padding: 10px 20px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .save-btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem; }
        .reset-btn { background: #6c757d; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; }
        .danger-btn { background: #dc3545; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .cancel-btn { background: transparent; color: var(--text-color); border: 1px solid var(--border); padding: 12px; border-radius: 6px; cursor: pointer; }
        .close-modal { font-size: 1.5em; cursor: pointer; background: none; border: none; color: var(--text-color); }

        .type-option { background: var(--input-bg); border: 2px solid var(--border); padding: 15px; border-radius: 8px; text-align: center; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .type-option:hover { border-color: var(--primary); }
        .type-option.active { background: var(--primary); color: white; border-color: var(--primary); }

        .settings-tabs { display: flex; gap: 5px; margin-bottom: 15px; background: var(--row-even); padding: 5px; border-radius: 8px; flex-shrink: 0; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: transparent; cursor: pointer; font-weight: bold; color: var(--text-color); border-radius: 6px; transition: 0.2s; }
        .tab-btn.active { background: var(--primary); color: white; }

        .rate-header-row { display: grid; gap: 8px; text-align: center; font-weight: bold; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 2px solid var(--border); font-size: 0.9em; flex-shrink: 0; }
        .rate-data-row { display: grid; gap: 8px; align-items: center; margin-bottom: 8px; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
        .rate-input { width: 100%; padding: 6px 2px; text-align: center; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-color); font-size: 0.9rem; }
        .range-cell { display: flex; flex-direction: column; gap: 4px; }
        .range-input { width: 100%; text-align: center; font-size: 0.85em; padding: 4px; border: 1px solid #aaa; background: #f8f9fa; border-radius: 3px; color: #333; font-weight: bold; }
        body.dark-mode .range-input { background: #333; color: #fff; border-color: #555; }
        .st-cell { display: flex; justify-content: center; align-items: center; }

        .worker-row { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 10px; padding: 10px; background: var(--row-even); border-radius: 6px; border: 1px solid var(--border); align-items: center; }
        .worker-row input { width: 100%; box-sizing: border-box; }
        .worker-row select { width: 100%; padding: 10px; }
        .worker-label { font-size: 0.8em; opacity: 0.6; margin-bottom: 2px; }

        /* Bank List Styling */
        .bank-list-item { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; padding:8px; background:var(--row-even); border-radius:6px; border:1px solid var(--border); }
        .bank-list-item label { margin:0; font-size:0.95em; }
        .bank-list-item input { width:120px; padding:8px; text-align:right; font-weight:bold; }
        
        /* Summary Table Styling */
        .summary-positive { color: green; font-weight: bold; }
        .summary-negative { color: red; font-weight: bold; }
        body.dark-mode .summary-positive { color: #4cd137; }
        body.dark-mode .summary-negative { color: #e84118; }
        
        /* BIGGER PRINT BUTTON */
        .print-btn-large {
            width: 100%;
            padding: 18px;
            font-size: 1.1rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        .print-btn-large:hover {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }

        /* ========================================= */
        /* === MOBILE RESPONSIVE TWEAKS (V8.0) === */
        /* ========================================= */
        @media (max-width: 600px) {
            body { padding: 0; }
            .container { padding: 15px; border-radius: 0; border: none; box-shadow: none; }
            .card-header-actions { gap: 5px; margin-bottom: 10px; }
            .type-btn { padding: 8px 10px; font-size: 0.8rem; }
            .icon-btn { min-width: 38px; height: 38px; padding: 5px; }
            h1 { font-size: 1.3rem; margin-bottom: 15px; }
            .input-grid { grid-template-columns: 1fr 1fr 1fr; gap: 10px; padding: 10px; }
            .form-group label { font-size: 0.8rem; }
            input, select { padding: 10px; font-size: 15px; }
            .form-group:nth-child(1), .form-group:nth-child(2) { grid-column: span 3; }
            .report-grid { grid-template-columns: 1fr; gap: 10px; }
            .table-container { max-height: 50vh; }
            th, td { padding: 10px 5px; font-size: 0.85rem; }
            .action-btn-shared { padding: 12px; font-size: 0.9rem; width: 100%; flex: none; }
            .report-panel { gap: 8px; flex-direction: column-reverse; }
            .print-btn { order: 4; } .csv-btn { order: 3; } .restore-btn { order: 2; } .clear-btn { order: 1; }
            
            .action-group { display: grid; grid-template-columns: 1fr 1fr; }
            .add-btn { grid-column: 1 / -1; } 
            .advance-btn, .bank-btn { grid-column: auto; }
            .report-view-btn { grid-column: 1 / -1; } 
            .summary-btn { grid-column: 1 / -1; }
        }

        /* ========================================= */
/* === MODERN MOBILE APP THEME (V9.0) === */
/* ========================================= */
@media (max-width: 600px) {
    body {
        padding: 10px;
        background-color: #f0f2f5; /* App-like gray background */
    }

    .container {
        padding: 20px 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05) !important;
    }

    /* Clean Header */
    h1 {
        font-size: 1.5rem;
        margin-bottom: 20px;
        font-weight: 800;
        letter-spacing: -0.5px;
    }

    .card-header-actions {
        gap: 10px;
        margin-bottom: 15px;
    }

    /* Layout Adjustments */
    .input-grid {
        display: flex; /* Better flow than grid on mobile */
        flex-direction: column;
        gap: 12px;
        padding: 20px;
    }

    /* Make Date/Worker/Size/Type/Qty consistent width */
    .form-group { width: 100%; }

    /* --- BUTTON LAYOUT (The specific request) --- */
    .action-group {
        display: grid;
        grid-template-columns: 1fr 1fr; /* Two columns */
        gap: 12px;
        margin-top: 10px;
    }

    /* 1. Advance & 2. Bank are side-by-side (Top Row) */
    .advance-btn, .bank-btn {
        grid-column: span 1; /* Take 1 slot each */
        padding: 14px;
        font-size: 0.85rem;
    }

    /* 3. Add to List (Middle - Big & Prominent) */
    .add-btn {
        grid-column: span 2; /* Take full width */
        background: linear-gradient(135deg, #0056b3, #004494); /* Gradient makes it pop */
        box-shadow: 0 4px 15px rgba(0, 86, 179, 0.4); /* Nice glow */
        padding: 16px;
        font-size: 1.1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* 4. Report & 5. Sheet (Bottom Row) */
    .report-view-btn, .summary-btn {
        grid-column: span 1;
        padding: 14px;
        font-size: 0.85rem;
    }

    /* Table Styling for Mobile */
    .table-container {
        border-radius: 12px;
        border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        background: white;
    }
    
    /* Footer Action Panel */
    .report-panel {
        gap: 10px;
        flex-direction: column; /* Stack buttons vertically for easy thumb reach */
    }
    
    .action-btn-shared {
        width: 100%;
        padding: 16px; /* Fat buttons for thumbs */
        font-size: 1rem;
    }
}
    </style>
</head>
<body>

<div id="splash-screen">
    <i class="far fa-gem splash-logo"></i>
    
    <div class="splash-title">CVD MANAGER</div>
    <div class="splash-subtitle">PRO EDITION</div>
    
    <div class="loading-container">
        <div class="loading-bar"></div>
    </div>
    
    <div class="splash-footer">DESIGNED BY AKSHAT DHANANI</div>
</div>

<div class="container">
    
    <div id="mainView">
        <div class="card-header-actions">
            <div><button class="icon-btn" onclick="toggleDarkMode()" title="Toggle Dark Mode">üåô</button></div>
            <button class="type-btn" onclick="openTypeModal()" id="typeDisplayBtn"><i class="far fa-gem"></i> <span id="currentTypeLabel">3EX</span></button>
            <div class="header-right">
                <button class="icon-btn" onclick="openWorkerModal()" title="Manage Workers">üë§</button>
                <button class="icon-btn" onclick="openSettings()" title="Edit Rates">‚öôÔ∏è</button>
            </div>
        </div>

        <h1>üíé CVD Diamond Manager</h1>

        <div class="input-grid">
            <div class="form-group">
                <label for="entryDate">Date</label>
                <input type="date" id="entryDate">
            </div>
            <div class="form-group">
                <label for="workerName">Worker Name</label>
                <input type="text" id="workerName" list="nameSuggestions" placeholder="Name" autocomplete="off" oninput="checkWorkerType()">
                <datalist id="nameSuggestions"></datalist>
            </div>
            <div class="form-group">
                <label for="diamondSize">Size</label>
                <input type="number" id="diamondSize" step="0.01" placeholder="2.50" oninput="updateRatePreview()">
            </div>
            <div class="form-group">
                <label for="diamondType">Type</label>
                <select id="diamondType" onchange="updateRatePreview()"></select>
            </div>
            <div class="form-group">
                <label for="quantity">Qty</label>
                <input type="number" id="quantity" placeholder="1" value="1">
            </div>
            <div id="rate-display" style="grid-column: 1/-1; font-style:italic; font-size:0.9em; margin-top:-5px;">Enter size...</div>
            
            <div class="action-group">
                <button class="advance-btn" onclick="openAdvanceModal()">üí∏ Monthly Advance</button>
                
                <button class="bank-btn" onclick="openBankModal()">üè¶ Monthly Bank</button>
                
                <button class="add-btn" id="addBtn" onclick="addEntry()">Add to List</button>
                
                <button class="report-view-btn" onclick="openWorkerReportView()">üìä Worker Report</button>
                
                <button class="summary-btn" onclick="openSummaryModal()">üìã Net Salary Sheet</button>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead><tr><th>Date</th><th>Worker</th><th>Size</th><th>Type</th><th>Rate</th><th>Qty</th><th>Total</th><th>Action</th></tr></thead>
                <tbody id="salaryTableBody"></tbody>
            </table>
        </div>

        <div class="total-section">
            <div class="grand-total">Total: ‚Çπ<span id="grandTotal">0.00</span></div>
        </div>

        <div class="report-panel">
            <button class="action-btn-shared clear-btn" onclick="openClearModal()">üóëÔ∏è Clear</button>
            <button class="action-btn-shared restore-btn" onclick="document.getElementById('importFile').click()">üì• Restore Full Backup</button>
            <button class="action-btn-shared csv-btn" onclick="exportToCSV()">üìä Backup Full Data</button>
            <button class="action-btn-shared print-btn" onclick="openDateModal()">üìÑ Download PDF</button>
        </div>
    </div>

    <div id="workerReportView">
        <div class="report-header">
            <button class="back-btn" onclick="closeWorkerReportView()">‚¨Ö Back</button>
            <h2 style="margin:0; color:var(--primary);">üìä Worker Report</h2>
            <div style="width:70px"></div>
        </div>

        <div class="report-grid">
            <div class="form-group">
                <label>Worker</label>
                <input type="text" id="reportWorkerName" list="nameSuggestions" placeholder="Select Name">
            </div>
            <div class="form-group">
                <label>From</label>
                <input type="date" id="reportStartDate">
            </div>
            <div class="form-group">
                <label>To</label>
                <input type="date" id="reportEndDate">
            </div>
            
            <div style="grid-column: 1/-1; display:flex; gap:10px; margin-top:5px;">
                <button class="add-btn" onclick="generateSpecificReport()">Show on Screen</button>
                <button class="print-btn" style="flex:1; border-radius:6px; font-weight:bold; border:none;" onclick="downloadWorkerPDF()">Download PDF</button>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead><tr><th>Date</th><th>Size</th><th>Type</th><th>Rate</th><th>Qty</th><th>Total</th></tr></thead>
                <tbody id="reportTableBody">
                    <tr><td colspan="6" style="text-align:center; opacity:0.6; padding:20px;">Select a worker and dates to see report.</td></tr>
                </tbody>
            </table>
        </div>

        <div class="total-section">
            <div class="grand-total">Worker Total: ‚Çπ<span id="reportTotal">0.00</span></div>
        </div>
    </div>

    <input type="file" id="importFile" accept=".csv,text/csv,application/vnd.ms-excel,text/plain" style="display:none" onchange="importCSV(this)">

    <div class="footer">
        &copy; 2025 Designed & Developed by <strong>Akshat Dhanani</strong>
    </div>
</div>

<div id="typeModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3>üíé Select Diamond Type</h3><span class="close-modal" onclick="closeTypeModal()">&times;</span></div>
        <div class="modal-scrollable-body">
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
                <div class="type-option active" id="opt3EX" onclick="selectType('3EX')">‚ú® CVD 3EX (Standard)</div>
                <div class="type-option" id="optComm" onclick="selectType('Commercial')">üè≠ CVD Commercial</div>
                <div class="type-option" id="optFancy" onclick="selectType('Fancy')">üå∏ Fancy Diamond</div>
            </div>
        </div>
    </div>
</div>

<div id="workerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3>üë§ Manage Workers</h3><span class="close-modal" onclick="closeWorkerModal()">&times;</span></div>
        <div class="modal-scrollable-body">
            <div style="margin-bottom:10px; font-size:0.9em; opacity:0.7; text-align:center;">Change names and assign Default Types.</div>
            <div id="workerListContainer"></div>
        </div>
        <div class="modal-actions">
            <button class="add-btn" style="background:#28a745; color:white; margin-bottom:10px;" onclick="addNewWorker()">+ Add New Worker</button>
            <button class="save-btn" onclick="closeWorkerModal()">Done</button>
        </div>
    </div>
</div>

<div id="advanceModal" class="modal">
    <div class="modal-content">
        <div class="modal-header" style="border-bottom-color: #ffc107;">
            <h3>üí∏ Monthly Advance (Cash)</h3>
            <span class="close-modal" onclick="closeAdvanceModal()">&times;</span>
        </div>
        <div class="modal-scrollable-body">
            <div class="form-group" style="margin-bottom:15px; background: var(--row-even); padding:10px; border-radius:8px; border:1px solid #ffc107;">
                <label>Select Month</label>
                <input type="month" id="advMonth" style="font-weight:bold;">
            </div>
            <div class="form-group" style="margin-bottom:15px">
                <label>Worker Name</label>
                <input type="text" id="advWorker" list="nameSuggestions" placeholder="Select Worker">
            </div>
            <div class="form-group" style="margin-bottom:15px">
                <label>Amount for this Month (‚Çπ)</label>
                <input type="number" id="advAmount" placeholder="Enter Amount">
            </div>
            
            <div class="modal-actions" style="padding: 0; border: none; margin-bottom: 20px;">
                <button class="save-btn" style="background-color: #ffc107; color:#333; width:100%;" onclick="saveAdvance()">Save / Update Monthly Advance</button>
            </div>

            <div style="border-top: 2px dashed var(--border); padding-top: 15px; margin-top: 10px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="margin:0; opacity:0.8;">üìú History</h4>
                    <button class="delete-btn" style="font-size: 0.8em; padding: 5px 10px;" onclick="clearAllAdvances()">üóëÔ∏è Clear All</button>
                </div>
                <div id="advanceHistoryContainer" style="max-height: 200px; overflow-y: auto; background: var(--row-even); border: 1px solid var(--border); border-radius: 6px; color: var(--text-color);">
                    </div>
            </div>
        </div>
    </div>
</div>

<div id="bankModal" class="modal">
    <div class="modal-content">
        <div class="modal-header" style="border-bottom-color: #6f42c1;">
            <h3>üè¶ Monthly Bank Salaries</h3>
            <span class="close-modal" onclick="closeBankModal()">&times;</span>
        </div>
        <div class="modal-scrollable-body">
            <div class="form-group" style="margin-bottom:15px; background: var(--row-even); padding:10px; border-radius:8px; border:1px solid #6f42c1;">
                <label style="color:#6f42c1;">üìÖ Select Salary Month:</label>
                <input type="month" id="bankMonth" style="font-weight:bold;">
            </div>
            
            <div style="margin-bottom:15px; font-size:0.9em; opacity:0.7; text-align:center;">
                Enter total amount for the selected month.<br>
                <b>(Re-entering updates existing amount)</b>
            </div>
            <div id="bankListContainer">
            </div>
        </div>
        <div class="modal-actions">
            <button class="save-btn" style="background-color: #6f42c1; color:white;" onclick="saveBankTransfer()">Save / Update Bank Sheet</button>
            <button class="cancel-btn" onclick="closeBankModal()">Cancel</button>
        </div>
    </div>
</div>

<div id="settingsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3>‚öôÔ∏è Rate Card</h3><span class="close-modal" onclick="closeSettings()">&times;</span></div>
        <div style="padding: 10px 20px 0px 20px;">
            <div class="settings-tabs">
                <button class="tab-btn active" id="tab3EX" onclick="switchSettingsTab('3EX')">3EX</button>
                <button class="tab-btn" id="tabCommercial" onclick="switchSettingsTab('Commercial')">Comm</button>
                <button class="tab-btn" id="tabFancy" onclick="switchSettingsTab('Fancy')">Fancy</button>
            </div>
            <div id="rateHeaderRow" class="rate-header-row"></div>
        </div>
        <div class="modal-scrollable-body" id="ratesList" style="padding-top:5px;"></div>
        <div class="modal-actions"><button class="reset-btn" onclick="resetRates()">Reset Defaults</button><button class="save-btn" onclick="saveRates()">Save Changes</button></div>
    </div>
</div>

<div id="dateModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3>üìÖ Report Date</h3><span class="close-modal" onclick="closeDateModal()">&times;</span></div>
        <div class="modal-scrollable-body">
            <div class="form-group" style="margin-bottom:15px"><label>From:</label><input type="date" id="startDate"></div>
            <div class="form-group"><label>To:</label><input type="date" id="endDate"></div>
        </div>
        <div class="modal-actions"><button class="save-btn" onclick="generateReport()">Download PDF</button><button class="cancel-btn" onclick="closeDateModal()">Cancel</button></div>
    </div>
</div>

<div id="clearModal" class="modal">
    <div class="modal-content">
        <div class="modal-header" style="border-bottom-color: #dc3545;"><h3 style="color: #dc3545;">üóëÔ∏è Clear Data</h3><button class="close-modal" onclick="closeClearModal()">&times;</span></div>
        <div class="modal-scrollable-body">
            <div style="margin-bottom: 15px; opacity:0.8; font-size:0.9em;">Select range or leave empty for ALL.</div>
            <div class="form-group" style="margin-bottom: 15px;"><label>From:</label><input type="date" id="clearStart"></div>
            <div class="form-group"><label>To:</label><input type="date" id="clearEnd"></div>
        </div>
        <div class="modal-actions"><button class="danger-btn" onclick="performClear()">Delete</button><button class="cancel-btn" onclick="closeClearModal()">Cancel</button></div>
    </div>
</div>

<div id="summaryModal" class="modal">
    <div class="modal-content wide-modal">
        <div class="modal-header" style="border-bottom-color: #20c997;">
            <h3>üìã Net Salary Sheet</h3>
            <span class="close-modal" onclick="closeSummaryModal()">&times;</span>
        </div>
        <div class="modal-scrollable-body">
            <div style="display:flex; gap:10px; margin-bottom:15px; background:var(--row-even); padding:10px; border-radius:8px; align-items:center;">
                <label style="margin:0;">üìÖ Select Month:</label>
                <input type="month" id="summaryMonth" style="padding:8px; border-radius:4px; border:1px solid #ccc;">
                <button class="summary-btn" style="padding:8px 15px; margin:0; font-size:0.9rem;" onclick="openSummaryModal()">Show</button>
            </div>

            <div class="table-container" style="max-height: 50vh;">
                <table id="summaryTable" style="font-size: 0.9em;">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Total Size (Cts)</th> <th>Total Work (+)</th>
                            <th>Cash Adv (-)</th>
                            <th>Bank Transfer (-)</th>
                            <th>Net Payable (=)</th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody">
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-actions">
            <button class="print-btn-large" onclick="printSummarySheet()">üñ®Ô∏è Print Summary Sheet</button>
            <button class="cancel-btn" style="width:100%; margin-top:5px;" onclick="closeSummaryModal()">Close</button>
        </div>
    </div>
</div>

<script>
    // --- RATES DATABASE ---
    const rates3EX_Default = [{ min: 0.30, max: 0.49, rates: { T: 527, P: 330, M: 368, F: 1225 } },{ min: 0.50, max: 0.69, rates: { T: 484, P: 303, M: 338, F: 1125 } },{ min: 0.70, max: 0.89, rates: { T: 441, P: 276, M: 308, F: 1025 } },{ min: 0.90, max: 0.99, rates: { T: 387, P: 243, M: 270, F: 900 } },{ min: 1.00, max: 1.49, rates: { T: 344, P: 216, M: 240, F: 800 } },{ min: 1.50, max: 1.99, rates: { T: 312, P: 195, M: 218, F: 725 } },{ min: 2.00, max: 2.99, rates: { T: 291, P: 182, M: 202, F: 675 } },{ min: 3.00, max: 3.99, rates: { T: 280, P: 175, M: 195, F: 650 } },{ min: 4.00, max: 4.99, rates: { T: 270, P: 168, M: 187, F: 625 } },{ min: 5.00, max: 9999, rates: { T: 248, P: 155, M: 172, F: 575 } }];
    const ratesComm_Default = [{ min: 0.30, max: 0.49, rates: { T: 195, P: 82, M: 107, F: 384 } },{ min: 0.50, max: 0.99, rates: { T: 174, P: 73, M: 96, F: 343 } },{ min: 1.00, max: 1.49, rates: { T: 152, P: 65, M: 84, F: 301 } },{ min: 1.50, max: 1.99, rates: { T: 147, P: 63, M: 81, F: 291 } },{ min: 2.00, max: 2.99, rates: { T: 137, P: 58, M: 75, F: 270 } },{ min: 3.00, max: 3.99, rates: { T: 132, P: 55, M: 72, F: 259 } },{ min: 4.00, max: 4.99, rates: { T: 126, P: 53, M: 70, F: 249 } },{ min: 5.00, max: 9999, rates: { T: 111, P: 46, M: 61, F: 218 } }];
    const ratesFancy_Default = [{ min: 0.30, max: 0.99, rates: { Full: 1500, Border: 1300 } },{ min: 1.00, max: 1.99, rates: { Full: 1300, Border: 1150 } },{ min: 2.00, max: 2.99, rates: { Full: 1100, Border: 900 } },{ min: 3.00, max: 4.99, rates: { Full: 950, Border: 800 } },{ min: 5.00, max: 9999, rates: { Full: 800, Border: 700 } }];

    let currentRates = [], entries = [], workerList = [], currentCategory = "3EX", editingCategory = "3EX", editingRates = [];
    let advances = []; 
    let bankTransfers = []; 

    window.onload = function() {
        // SPLASH SCREEN LOGIC
        setTimeout(() => {
            const splash = document.getElementById('splash-screen');
            splash.style.opacity = '0';
            setTimeout(() => {
                splash.style.visibility = 'hidden';
            }, 600);
        }, 2500); 

        if (localStorage.getItem('darkMode') === 'enabled') document.body.classList.add('dark-mode');
        
        const today = new Date();
        const y = today.getFullYear();
        const m = String(today.getMonth() + 1).padStart(2, '0');
        const d = String(today.getDate()).padStart(2, '0');
        const todayStr = `${y}-${m}-${d}`;
        
        // Set Default Date Inputs
        document.getElementById('entryDate').value = todayStr;
        document.getElementById('reportStartDate').value = todayStr;
        document.getElementById('reportEndDate').value = todayStr;
        document.getElementById('summaryMonth').value = `${y}-${m}`; // Default to current month for summary

        const savedData = localStorage.getItem('diamondData');
        if (savedData) entries = JSON.parse(savedData);

        const savedAdvances = localStorage.getItem('advanceData');
        if (savedAdvances) advances = JSON.parse(savedAdvances);

        const savedBank = localStorage.getItem('bankData');
        if (savedBank) bankTransfers = JSON.parse(savedBank);

        // --- NEW: PRESS ENTER IN SIZE BOX TO ADD ---
        document.getElementById("diamondSize").addEventListener("keydown", function(event) {
            if (event.key === "Enter") {
                event.preventDefault(); // Stop normal "Enter" behavior
                addEntry(); // Trigger the Add button logic
            }
        });
        
        initWorkers();
        selectType('3EX'); 
        renderTable();
        updateSuggestions();
    };

    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); localStorage.setItem('darkMode', document.body.classList.contains('dark-mode') ? 'enabled' : 'disabled'); }

    // --- WORKER REPORT LOGIC ---
    function openWorkerReportView() { document.getElementById('mainView').style.display = 'none'; document.getElementById('workerReportView').style.display = 'block'; }
    function closeWorkerReportView() { document.getElementById('workerReportView').style.display = 'none'; document.getElementById('mainView').style.display = 'block'; }

    // --- UPDATED REPORT VIEW LOGIC (With Total Size) ---
    function generateSpecificReport() {
        const name = document.getElementById('reportWorkerName').value.trim();
        const s = document.getElementById('reportStartDate').value;
        const e = document.getElementById('reportEndDate').value;
        const tbody = document.getElementById('reportTableBody');
        const totalSection = document.querySelector('#workerReportView .total-section');
        
        if(!name || !s || !e) { alert("Please enter Name and Dates."); return; }

        const d1 = new Date(s); d1.setHours(0,0,0,0);
        const d2 = new Date(e); d2.setHours(23,59,59,999);

        // 1. Filter Work Entries
        const filtered = entries.filter(item => {
            const p = item.date.split('/'); 
            const itemDate = new Date(p[2], p[1]-1, p[0]);
            return (item.name.toLowerCase() === name.toLowerCase() && itemDate >= d1 && itemDate <= d2);
        });

        // 2. Filter Advances (Now captures monthly date 01/MM/YYYY)
        const workerAdvances = advances.filter(item => {
            const p = item.date.split('/'); 
            const itemDate = new Date(p[2], p[1]-1, p[0]);
            return (item.name.toLowerCase() === name.toLowerCase() && itemDate >= d1 && itemDate <= d2);
        });

        // 3. Filter Bank Transfers (Now captures monthly date 01/MM/YYYY)
        const workerBank = bankTransfers.filter(item => {
            const p = item.date.split('/'); 
            const itemDate = new Date(p[2], p[1]-1, p[0]);
            return (item.name.toLowerCase() === name.toLowerCase() && itemDate >= d1 && itemDate <= d2);
        });

        tbody.innerHTML = '';
        let totalWork = 0;
        let totalAdv = 0;
        let totalBank = 0;
        let totalSize = 0; // NEW: Total Size variable

        // Calculate Work Total & Render Table
        if(filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:15px;">No work entries found for this period.</td></tr>';
        } else {
            filtered.sort((a,b) => {
                const da = a.date.split('/'), db = b.date.split('/');
                return new Date(da[2],da[1]-1,da[0]) - new Date(db[2],db[1]-1,db[0]);
            });

            filtered.forEach(r => {
                totalWork += r.total;
                totalSize += r.size; // NEW: Add size
                let c = (r.category==='Commercial')?'commercial-row':(r.category==='Fancy')?'fancy-row':'';
                tbody.insertAdjacentHTML('beforeend', `<tr class="${c}"><td>${r.date}</td><td>${r.size.toFixed(2)}</td><td>${r.type}</td><td>${r.rate}</td><td>${r.qty}</td><td><strong>‚Çπ${r.total.toFixed(2)}</strong></td></tr>`);
            });
        }

        // Calculate Deductions
        workerAdvances.forEach(a => totalAdv += a.amount);
        workerBank.forEach(b => totalBank += b.amount);

        // Calculate Net Payable
        const netPayable = totalWork - totalAdv - totalBank;
        const netClass = netPayable >= 0 ? 'color:green' : 'color:red';

        // 4. Update the Total Section UI
        totalSection.style.display = 'block'; 
        totalSection.style.textAlign = 'right';
        totalSection.innerHTML = `
            <div style="display:flex; justify-content:flex-end; gap:30px; flex-wrap:wrap; font-size:1rem;">
                <div style="color:var(--primary)">Total Size: <b>${totalSize.toFixed(2)} Cts</b></div>
                <div>Total Work: <b>‚Çπ${totalWork.toFixed(2)}</b></div>
                <div style="color:#d9534f">Cash Adv: <b>- ‚Çπ${totalAdv.toFixed(2)}</b></div>
                <div style="color:#6f42c1">Bank Transfer: <b>- ‚Çπ${totalBank.toFixed(2)}</b></div>
            </div>
            <div style="margin-top:10px; border-top:2px solid #ddd; padding-top:10px; font-size:1.4rem; font-weight:bold; ${netClass}">
                Net Payable: ‚Çπ${netPayable.toFixed(2)}
            </div>
        `;
    }

    // --- UPDATED MONTHLY ADVANCE LOGIC ---

    function openAdvanceModal() {
        const today = new Date();
        const y = today.getFullYear();
        const m = String(today.getMonth() + 1).padStart(2, '0');
        document.getElementById('advMonth').value = `${y}-${m}`; // Default current month
        document.getElementById('advWorker').value = '';
        document.getElementById('advAmount').value = '';
        
        renderAdvanceHistory();
        document.getElementById('advanceModal').style.display = 'flex';
    }
    
    function closeAdvanceModal() { document.getElementById('advanceModal').style.display = 'none'; }
    
    function renderAdvanceHistory() {
        const container = document.getElementById('advanceHistoryContainer');
        
        if (advances.length === 0) {
            container.innerHTML = '<div style="padding:15px; text-align:center; opacity:0.6; font-size:0.9em;">No advance history found.</div>';
            return;
        }

        const sorted = [...advances].sort((a, b) => b.id - a.id);

        let html = '<table style="width:100%; font-size:0.85em; margin:0;">';
        html += '<tr style="background:var(--table-header); color:white; position:sticky; top:0;"><th>Date</th><th>Name</th><th>Amt</th><th>Del</th></tr>';
        
        sorted.forEach(item => {
            html += `<tr>
                <td style="padding:8px;">${item.date}</td>
                <td style="padding:8px;">${item.name}</td>
                <td style="padding:8px; font-weight:bold;">‚Çπ${item.amount}</td>
                <td style="text-align:center;">
                    <button style="background:transparent; border:none; color:red; cursor:pointer;" onclick="deleteSingleAdvance(${item.id})">‚úñ</button>
                </td>
            </tr>`;
        });
        
        html += '</table>';
        container.innerHTML = html;
    }

    function clearAllAdvances() {
        if (advances.length === 0) return alert("History is already empty.");
        if(confirm("‚ö†Ô∏è ARE YOU SURE?\n\nThis will delete ALL advance payment history permanently.\nThis cannot be undone.")) {
            advances = [];
            localStorage.setItem('advanceData', JSON.stringify(advances));
            renderAdvanceHistory();
            alert("All advance history cleared.");
        }
    }

    function deleteSingleAdvance(id) {
        if(confirm("Delete this single entry?")) {
            advances = advances.filter(a => a.id !== id);
            localStorage.setItem('advanceData', JSON.stringify(advances));
            renderAdvanceHistory();
        }
    }

    function saveAdvance() {
        const monthStr = document.getElementById('advMonth').value; // YYYY-MM
        const nm = document.getElementById('advWorker').value.trim();
        const amt = parseFloat(document.getElementById('advAmount').value);
        
        if(!monthStr || !nm || !amt) { alert("Please fill all details"); return; }
        
        // Convert YYYY-MM to 01/MM/YYYY for standardized monthly storage
        const [y, m] = monthStr.split('-');
        const fDate = `01/${m}/${y}`;
        
        // CHECK IF ENTRY EXISTS (Update logic)
        const existingIndex = advances.findIndex(a => a.name.toLowerCase() === nm.toLowerCase() && a.date === fDate);

        if(existingIndex > -1) {
             // Update existing
             advances[existingIndex].amount = amt;
             alert(`Updated Advance for ${nm} in ${m}/${y}`);
        } else {
             // Create new
             advances.push({ id: Date.now(), date: fDate, name: nm, amount: amt });
             alert(`Saved Advance for ${nm}`);
        }

        localStorage.setItem('advanceData', JSON.stringify(advances));
        
        document.getElementById('advAmount').value = '';
        renderAdvanceHistory();
    }

    // --- UPDATED MONTHLY BANK TRANSFER LOGIC ---
    function openBankModal() {
        const today = new Date();
        const y = today.getFullYear();
        const m = String(today.getMonth() + 1).padStart(2, '0');
        document.getElementById('bankMonth').value = `${y}-${m}`;

        const container = document.getElementById('bankListContainer');
        container.innerHTML = '';
        
        workerList.forEach((w, index) => {
            const defaultAmt = w.defaultBankSalary || 0;
            const html = `
            <div class="bank-list-item">
                <label>${w.name}</label>
                <input type="number" id="bank_input_${index}" data-name="${w.name}" value="${defaultAmt}" placeholder="0">
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
        });

        document.getElementById('bankModal').style.display = 'flex';
    }
    function closeBankModal() { document.getElementById('bankModal').style.display = 'none'; }
    
    function saveBankTransfer() {
        const monthStr = document.getElementById('bankMonth').value;
        if(!monthStr) { alert("Please select a Month."); return; }

        const [y, m] = monthStr.split('-');
        const fDate = `01/${m}/${y}`;
        
        let updatedCount = 0;
        
        workerList.forEach((w, index) => {
            const inp = document.getElementById(`bank_input_${index}`);
            const val = parseFloat(inp.value) || 0; 
            
            w.defaultBankSalary = val;

            const existingIndex = bankTransfers.findIndex(b => b.name === w.name && b.date === fDate);

            if (val > 0) {
                if (existingIndex > -1) {
                    bankTransfers[existingIndex].amount = val;
                } else {
                    bankTransfers.push({ id: Date.now() + index, date: fDate, name: w.name, amount: val });
                }
                updatedCount++;
            } else {
                if (existingIndex > -1) {
                    bankTransfers.splice(existingIndex, 1);
                }
            }
        });

        saveWorkers(); 
        localStorage.setItem('bankData', JSON.stringify(bankTransfers)); 
        
        alert(`‚úÖ Bank Salaries Saved for ${m}/${y}!`);
        closeBankModal();
        
        if(document.getElementById('summaryModal').style.display === 'flex') {
            openSummaryModal(); 
        }
    }

    // --- UPDATED SUMMARY SHEET WITH TOTAL SIZE COLUMN ---
    function openSummaryModal() {
        // Get Selected Month
        const monthStr = document.getElementById('summaryMonth').value;
        
        // If no month is selected (first run), default to current
        if(!monthStr) {
            const today = new Date();
            const y = today.getFullYear();
            const m = String(today.getMonth() + 1).padStart(2, '0');
            document.getElementById('summaryMonth').value = `${y}-${m}`;
            // Recursive call to reload with default value
            setTimeout(openSummaryModal, 10);
            return;
        }

        const [y, m] = monthStr.split('-');
        // Define date range for this month
        const d1 = new Date(parseInt(y), parseInt(m)-1, 1);
        const d2 = new Date(parseInt(y), parseInt(m), 0, 23, 59, 59);

        const tbody = document.getElementById('summaryTableBody');
        tbody.innerHTML = '';

        const allNames = new Set([
            ...entries.map(e => e.name),
            ...advances.map(a => a.name),
            ...bankTransfers.map(b => b.name),
            ...workerList.map(w => w.name)
        ]);
        
        const sortedNames = Array.from(allNames).sort();

        let grandTotalWork = 0;
        let grandTotalAdv = 0;
        let grandTotalBank = 0;
        let grandTotalSize = 0; // NEW: Grand Total Size
        let totalPayable = 0;   
        let totalReceivable = 0; 

        let hasData = false;

        sortedNames.forEach(name => {
            // Filter Data by Name AND Date Range
            const workerEntries = entries.filter(item => {
                const p = item.date.split('/'); 
                const itemDate = new Date(p[2], p[1]-1, p[0]);
                return (item.name === name && itemDate >= d1 && itemDate <= d2);
            });

            // Calculate Totals
            const totalWork = workerEntries.reduce((sum, item) => sum + item.total, 0);
            const totalSize = workerEntries.reduce((sum, item) => sum + item.size, 0); // NEW: Calculate Worker Size

            const totalAdv = advances.filter(item => {
                const p = item.date.split('/'); 
                const itemDate = new Date(p[2], p[1]-1, p[0]);
                return (item.name === name && itemDate >= d1 && itemDate <= d2);
            }).reduce((sum, item) => sum + item.amount, 0);

            const totalBank = bankTransfers.filter(item => {
                const p = item.date.split('/'); 
                const itemDate = new Date(p[2], p[1]-1, p[0]);
                return (item.name === name && itemDate >= d1 && itemDate <= d2);
            }).reduce((sum, item) => sum + item.amount, 0);
            
            if (totalWork === 0 && totalAdv === 0 && totalBank === 0) return;
            
            hasData = true;

            const netPayable = totalWork - totalAdv - totalBank;
            const netClass = netPayable >= 0 ? 'summary-positive' : 'summary-negative';

            grandTotalWork += totalWork;
            grandTotalAdv += totalAdv;
            grandTotalBank += totalBank;
            grandTotalSize += totalSize; // Add to Grand Total
            
            if (netPayable >= 0) totalPayable += netPayable; else totalReceivable += netPayable;

            tbody.insertAdjacentHTML('beforeend', `
                <tr>
                    <td style="font-weight:bold;">${name}</td>
                    <td>${totalSize.toFixed(2)}</td> <td>‚Çπ${totalWork.toFixed(2)}</td>
                    <td style="color:#d9534f">‚Çπ${totalAdv.toFixed(2)}</td>
                    <td style="color:#6f42c1">‚Çπ${totalBank.toFixed(2)}</td>
                    <td class="${netClass}">‚Çπ${netPayable.toFixed(2)}</td>
                </tr>
            `);
        });

        if (!hasData) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; opacity:0.6">No data for selected month.</td></tr>';
        } else {
            tbody.insertAdjacentHTML('beforeend', `
                <tr style="background-color:var(--row-even); border-top: 2px solid var(--text-color); font-weight:bold; font-size:1.05em;">
                    <td style="text-align:right;">TOTAL:</td>
                    <td>${grandTotalSize.toFixed(2)}</td> <td>‚Çπ${grandTotalWork.toFixed(2)}</td>
                    <td style="color:#d9534f">‚Çπ${grandTotalAdv.toFixed(2)}</td>
                    <td style="color:#6f42c1">‚Çπ${grandTotalBank.toFixed(2)}</td>
                    <td>
                        <div style="color:green; border-bottom:1px solid #ccc; padding-bottom:2px;">Pay: ‚Çπ${totalPayable.toFixed(2)}</div>
                        <div style="color:red; padding-top:2px;">Rec: ‚Çπ${totalReceivable.toFixed(2)}</div>
                    </td>
                </tr>
            `);
        }

        document.getElementById('summaryModal').style.display = 'flex';
    }

    function closeSummaryModal() {
        document.getElementById('summaryModal').style.display = 'none';
    }

    function printSummarySheet() {
        const content = document.getElementById('summaryTable').outerHTML;
        const m = document.getElementById('summaryMonth').value;
        const w = window.open('', '_blank');
        w.document.write(`<html><head><title>Net Salary Sheet</title>
        <style>
            body{font-family:sans-serif; padding:20px;}
            h1{text-align:center; border-bottom:2px solid #333;}
            table{width:100%; border-collapse:collapse; margin-top:20px;}
            th, td{border:1px solid #ccc; padding:10px; text-align:left;}
            th{background:#eee;}
            .summary-positive{color:green; font-weight:bold;}
            .summary-negative{color:red; font-weight:bold;}
        </style>
        </head><body>
            <h1>üìã Net Salary Summary Sheet</h1>
            <center><h3>Month: ${m}</h3></center>
            ${content}
            <script>window.print()<\/script>
        </body></html>`);
        w.document.close();
    }


    // --- PDF REPORT (UPDATED WITH TOTAL SIZE) ---
    function downloadWorkerPDF() {
        const name = document.getElementById('reportWorkerName').value.trim();
        const s = document.getElementById('reportStartDate').value;
        const e = document.getElementById('reportEndDate').value;
        
        if(!name || !s || !e) { alert("Please enter Name and Dates."); return; }

        const d1 = new Date(s); d1.setHours(0,0,0,0);
        const d2 = new Date(e); d2.setHours(23,59,59,999);

        const filtered = entries.filter(item => {
            const p = item.date.split('/'); const itemDate = new Date(p[2], p[1]-1, p[0]);
            return (item.name.toLowerCase() === name.toLowerCase() && itemDate >= d1 && itemDate <= d2);
        });
        
        const workerAdvances = advances.filter(item => {
            const p = item.date.split('/'); const itemDate = new Date(p[2], p[1]-1, p[0]);
            return (item.name.toLowerCase() === name.toLowerCase() && itemDate >= d1 && itemDate <= d2);
        });
        
        const workerBank = bankTransfers.filter(item => {
            const p = item.date.split('/'); const itemDate = new Date(p[2], p[1]-1, p[0]);
            return (item.name.toLowerCase() === name.toLowerCase() && itemDate >= d1 && itemDate <= d2);
        });

        if(filtered.length === 0 && workerAdvances.length === 0 && workerBank.length === 0) { alert("No entries found."); return; }

        filtered.sort((a,b) => {
            const da = a.date.split('/'), db = b.date.split('/');
            return new Date(da[2],da[1]-1,da[0]) - new Date(db[2],db[1]-1,db[0]);
        });

        let totalAmt = 0, totalQty = 0, totalSize = 0;
        let totalAdvance = 0, totalBank = 0;
        workerAdvances.forEach(a => totalAdvance += a.amount);
        workerBank.forEach(b => totalBank += b.amount);

        let h = `<html><head><title>Worker Report - ${name}</title><style>body{font-family:sans-serif;padding:20px}h1{text-align:center;border-bottom:2px solid #333}table{width:100%;border-collapse:collapse;margin-top:10px}th,td{border:1px solid #ccc;padding:8px;text-align:left;font-size:0.9em}th{background:#eee}.comm{background-color:#fff9c4 !important;-webkit-print-color-adjust:exact}.fancy{background-color:#f8d7da !important;-webkit-print-color-adjust:exact}</style></head><body>`;
        
        h += `<h1>üíé Salary Report</h1><center><h3>üë§ ${name}</h3>(${s.split('-').reverse().join('/')} to ${e.split('-').reverse().join('/')})</center>`;
        
        h += `<table><thead><tr><th>Date</th><th>Type</th><th>Size</th><th>Rate</th><th>Qty</th><th>Total</th></tr></thead><tbody>`;

        filtered.forEach(r => {
            totalAmt += r.total; totalQty += r.qty; totalSize += r.size;
            let bg = (r.category === 'Commercial') ? 'class="comm"' : (r.category === 'Fancy') ? 'class="fancy"' : '';
            h += `<tr ${bg}><td>${r.date}</td><td>${r.type}</td><td>${r.size.toFixed(2)}</td><td>${r.rate}</td><td>${r.qty}</td><td>${r.total.toFixed(2)}</td></tr>`;
        });
        
        const netPayable = totalAmt - totalAdvance - totalBank;

        h += `</tbody><tfoot>
            <tr>
                <td colspan="2" align="right"><b>Totals:</b></td>
                <td><b>${totalSize.toFixed(2)} Cts</b></td>
                <td align="center">-</td>
                <td><b>${totalQty} Pcs</b></td>
                <td><b>‚Çπ${totalAmt.toFixed(2)}</b></td>
            </tr>
            <tr><td colspan="5" align="right" style="color:#d9534f"><b>Less: Cash Advance:</b></td><td style="color:#d9534f"><b>- ‚Çπ${totalAdvance.toFixed(2)}</b></td></tr>
            <tr><td colspan="5" align="right" style="color:#6f42c1"><b>Less: Bank Transfer:</b></td><td style="color:#6f42c1"><b>- ‚Çπ${totalBank.toFixed(2)}</b></td></tr>
            <tr><td colspan="5" align="right" style="font-size:1.2em"><b>Net Payable:</b></td><td style="font-size:1.2em; border-top:2px solid #000; color:${netPayable>=0?'green':'red'}"><b>‚Çπ${netPayable.toFixed(2)}</b></td></tr>
            </tfoot></table>`;
        
        if(workerAdvances.length > 0 || workerBank.length > 0) {
            h += `<h4>Payment History:</h4><ul>`;
            workerAdvances.forEach(a => h += `<li>(Cash) ${a.date}: ‚Çπ${a.amount}</li>`);
            workerBank.forEach(b => h += `<li>(Bank) ${b.date}: ‚Çπ${b.amount}</li>`);
            h += `</ul>`;
        }

        h += `<script>window.print()<\/script></body></html>`;

        const w = window.open('', '_blank'); w.document.write(h); w.document.close();
    }

    // --- WORKER MANAGEMENT ---
    function initWorkers() {
        const saved = localStorage.getItem('workerList');
        if (saved) { workerList = JSON.parse(saved); } 
        else { for(let i=1; i<=35; i++) { workerList.push({ name: `Worker ${i}`, defaultType: 'T' }); } saveWorkers(); }
        updateSuggestions();
    }
    function saveWorkers() { localStorage.setItem('workerList', JSON.stringify(workerList)); updateSuggestions(); }
    function openWorkerModal() { document.getElementById('workerModal').style.display = 'flex'; renderWorkerManagerList(); }
    function closeWorkerModal() { document.getElementById('workerModal').style.display = 'none'; }
    function renderWorkerManagerList() {
        const c = document.getElementById('workerListContainer'); c.innerHTML = '';
        const opts = ['T', 'P', 'M', 'F', 'TP', 'Full', 'Border'];
        workerList.forEach((w, i) => {
            let oH = opts.map(o => `<option value="${o}" ${w.defaultType === o ? 'selected' : ''}>${o}</option>`).join('');
            c.insertAdjacentHTML('beforeend', `<div class="worker-row"><div><div class="worker-label">Name</div><input type="text" value="${w.name}" onchange="updateWorkerName(${i}, this.value)"></div><div><div class="worker-label">Default Type</div><select onchange="updateWorkerType(${i}, this.value)">${oH}</select></div></div>`);
        });
    }
    
    // --- ADD WORKER FUNCTION ---
    function addNewWorker() {
        const n = prompt("Enter New Worker Name:");
        if(n && n.trim()) {
            workerList.push({ name: n.trim(), defaultType: 'T' });
            saveWorkers(); 
            renderWorkerManagerList(); 
            
            // Auto-scroll to bottom to see new worker
            const c = document.getElementById('workerListContainer');
            setTimeout(() => c.scrollTop = c.scrollHeight, 100);
        }
    }
    
    function updateWorkerName(i, n) { if(n.trim()){ workerList[i].name=n; saveWorkers(); } }
    function updateWorkerType(i, t) { workerList[i].defaultType=t; saveWorkers(); }
    function checkWorkerType() {
        const val = document.getElementById('workerName').value;
        const w = workerList.find(x => x.name.toLowerCase() === val.toLowerCase());
        if(w) {
            const sel = document.getElementById('diamondType');
            if(Array.from(sel.options).some(o => o.value === w.defaultType)) { sel.value = w.defaultType; updateRatePreview(); }
        }
    }

    // --- MAIN APP LOGIC ---
    function openTypeModal() { document.getElementById('typeModal').style.display = 'flex'; }
    function closeTypeModal() { document.getElementById('typeModal').style.display = 'none'; }
    function selectType(t) {
        currentCategory = t; document.getElementById('currentTypeLabel').innerText = (t==='Commercial')?"COMM":t;
        document.querySelectorAll('.type-option').forEach(e=>e.classList.remove('active'));
        if(t==='3EX')document.getElementById('opt3EX').classList.add('active');
        if(t==='Commercial')document.getElementById('optComm').classList.add('active');
        if(t==='Fancy')document.getElementById('optFancy').classList.add('active');
        const sel = document.getElementById('diamondType');
        sel.innerHTML = (t==='Fancy')?'<option value="Full">Full</option><option value="Border">Border</option>':'<option value="T">T</option><option value="P">P</option><option value="M">M</option><option value="F">F</option><option value="TP">TP (T+P)</option>';
        currentRates = getRatesForCategory(t); updateRatePreview(); closeTypeModal();
    }
    function getRatesForCategory(c) {
        const s = localStorage.getItem('rates_'+c.toLowerCase());
        return s ? JSON.parse(s) : JSON.parse(JSON.stringify((c==='3EX')?rates3EX_Default:(c==='Commercial')?ratesComm_Default:ratesFancy_Default));
    }
    function findRate(s, t) {
        const r = currentRates.find(x => s >= x.min && s <= x.max);
        if(!r) return 0;
        return (t==='TP') ? (r.rates['T']||0)+(r.rates['P']||0) : (r.rates[t]||0);
    }
    function updateRatePreview() {
        const s = parseFloat(document.getElementById('diamondSize').value), t = document.getElementById('diamondType').value;
        const d = document.getElementById('rate-display');
        if(s && t) { const r = findRate(s,t); d.innerText = r>0 ? `Rate: ‚Çπ${r} (${currentCategory})` : "Size not found"; d.style.color = r>0 ? (document.body.classList.contains('dark-mode')?"#4dabf7":"green") : "#dc3545"; }
    }
    function addEntry() {
        const raw = document.getElementById('entryDate').value; 
        if (!raw) { alert("Select Date"); return; }
        const [y, m, d] = raw.split('-');
        const fDate = `${d}/${m}/${y}`; 

        const nm = document.getElementById('workerName').value.trim();
        const sz = parseFloat(document.getElementById('diamondSize').value);
        const tp = document.getElementById('diamondType').value;
        let qt = parseFloat(document.getElementById('quantity').value)||1;
        
        // Basic Validation
        if(!nm) { alert("Please enter Worker Name"); document.getElementById('workerName').focus(); return; }
        if(!sz) { alert("Please enter Size"); document.getElementById('diamondSize').focus(); return; }
        
        const rt = findRate(sz, tp); 
        if(rt===0) { alert("Rate not found for this Size/Type!"); return; }
        
        // Add to Array
        entries.push({ id: Date.now(), date: fDate, name: nm, size: sz, type: tp, rate: rt, qty: qt, total: sz*rt*qt, category: currentCategory });
        
        // Save and Render
        saveData(); 
        renderTable(); 
        updateSuggestions();
        
        // --- RAPID ENTRY RESET ---
        document.getElementById('diamondSize').value = ''; // Clear Size only
        document.getElementById('quantity').value = '1';   // Reset Qty to 1
        
        // KEEP FOCUS ON SIZE INPUT (So you can type next size immediately)
        document.getElementById('diamondSize').focus(); 
    }
    function deleteEntry(id) { if(confirm("Remove?")) { entries=entries.filter(e=>e.id!==id); saveData(); renderTable(); updateSuggestions(); } }
    function saveData() { localStorage.setItem('diamondData', JSON.stringify(entries)); }
    function updateSuggestions() {
        const dl = document.getElementById('nameSuggestions'); dl.innerHTML = ''; 
        workerList.forEach(w => { const o = document.createElement('option'); o.value = w.name; dl.appendChild(o); });
    }
    function renderTable() {
        const tb = document.getElementById('salaryTableBody'); tb.innerHTML=''; let gt=0;
        [...entries].reverse().forEach(e => {
            gt+=e.total;
            let c = (e.category==='Commercial')?'commercial-row':(e.category==='Fancy')?'fancy-row':'';
            tb.insertAdjacentHTML('beforeend', `<tr class="${c}"><td>${e.date}</td><td>${e.name}</td><td>${e.size.toFixed(2)}</td><td>${e.type}</td><td>${e.rate}</td><td>${e.qty}</td><td><strong>‚Çπ${e.total.toFixed(2)}</strong></td><td><button class="delete-btn" onclick="deleteEntry(${e.id})">X</button></td></tr>`);
        });
        document.getElementById('grandTotal').innerText = gt.toFixed(2);
    }

    // --- SETTINGS, IMPORT, EXPORT, PDF ---
    function openSettings(){ switchSettingsTab(currentCategory); document.getElementById('settingsModal').style.display='flex'; }
    function closeSettings(){ document.getElementById('settingsModal').style.display='none'; }
    function switchSettingsTab(t){
        editingCategory=t; editingRates=getRatesForCategory(t);
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        if(t==='3EX')document.getElementById('tab3EX').classList.add('active'); if(t==='Commercial')document.getElementById('tabCommercial').classList.add('active'); if(t==='Fancy')document.getElementById('tabFancy').classList.add('active');
        const l=document.getElementById('ratesList'), h=document.getElementById('rateHeaderRow'); l.innerHTML='';
        let cols=(t==='Fancy')?['Full','Border']:['T','P','M','F'];
        let colT = `1.2fr repeat(${cols.length}, 1fr)`; h.style.gridTemplateColumns = colT;
        h.innerHTML = `<span>Size (Cts)</span>` + cols.map(c=>`<span>${c}</span>`).join('');
        editingRates.forEach((r,i) => {
            let inps = cols.map(c => `<div class="st-cell"><input type="number" class="rate-input" id="r-${i}-${c}" value="${r.rates[c]}"></div>`).join('');
            l.insertAdjacentHTML('beforeend', `<div class="rate-data-row" style="grid-template-columns:${colT}"><div class="st-cell range-cell"><input type="number" step="0.01" class="range-input" id="min-${i}" value="${r.min}"><input type="number" step="0.01" class="range-input" id="max-${i}" value="${r.max}"></div>${inps}</div>`);
        });
    }
    function saveRates(){
        let cols=(editingCategory==='Fancy')?['Full','Border']:['T','P','M','F'];
        editingRates.forEach((r,i) => { r.min=parseFloat(document.getElementById(`min-${i}`).value)||0; r.max=parseFloat(document.getElementById(`max-${i}`).value)||0; cols.forEach(c => r.rates[c]=parseInt(document.getElementById(`r-${i}-${c}`).value)||0); });
        localStorage.setItem('rates_'+editingCategory.toLowerCase(), JSON.stringify(editingRates));
        if(editingCategory===currentCategory) { currentRates=JSON.parse(JSON.stringify(editingRates)); updateRatePreview(); }
        closeSettings();
    }
    function resetRates() { if(confirm("Reset?")) { editingRates=JSON.parse(JSON.stringify((editingCategory==='3EX')?rates3EX_Default:(editingCategory==='Commercial')?ratesComm_Default:ratesFancy_Default)); renderSettingsTable(); } }
    
    function openDateModal(){document.getElementById('dateModal').style.display='flex';} function closeDateModal(){document.getElementById('dateModal').style.display='none';}
    function openClearModal(){document.getElementById('clearModal').style.display='flex';} function closeClearModal(){document.getElementById('clearModal').style.display='none';}
    function performClear() {
        const s = document.getElementById('clearStart').value, e = document.getElementById('clearEnd').value;
        if (!s && !e) { if(confirm("Delete ALL?")) { entries=[]; advances=[]; bankTransfers=[]; localStorage.setItem('advanceData','[]'); localStorage.setItem('bankData','[]'); saveData(); renderTable(); updateSuggestions(); closeClearModal(); } return; }
        if (s && e) {
            const d1 = new Date(s); d1.setHours(0,0,0,0); const d2 = new Date(e); d2.setHours(23,59,59,999);
            entries = entries.filter(i => { const p = i.date.split('/'); const d = new Date(p[2], p[1]-1, p[0]); return !(d >= d1 && d <= d2); });
            // Also clear advances & bank in range
            advances = advances.filter(i => { const p = i.date.split('/'); const d = new Date(p[2], p[1]-1, p[0]); return !(d >= d1 && d <= d2); });
            bankTransfers = bankTransfers.filter(i => { const p = i.date.split('/'); const d = new Date(p[2], p[1]-1, p[0]); return !(d >= d1 && d <= d2); });
            localStorage.setItem('advanceData', JSON.stringify(advances));
            localStorage.setItem('bankData', JSON.stringify(bankTransfers));
            saveData(); renderTable(); updateSuggestions(); closeClearModal();
        } else alert("Select both dates.");
    }
    
    // --- EXPORT TO CSV (FULL BACKUP) ---
    function exportToCSV() {
        if (!entries.length && !advances.length && !bankTransfers.length && !workerList.length) { return alert("No data to export!"); }

        let csv = "DataType,Date,Name,Category/Info,Size,Type,Rate,Qty,Amount/Total\n";

        // Add WORK Entries
        entries.forEach(e => { csv += `WORK,${e.date},${e.name},${e.category},${e.size},${e.type},${e.rate},${e.qty},${e.total}\n`; });
        // Add ADVANCE Payments
        advances.forEach(a => { csv += `ADVANCE,${a.date},${a.name},,,,,,${a.amount}\n`; });
        // Add BANK Transfers
        bankTransfers.forEach(b => { csv += `BANK,${b.date},${b.name},,,,,,${b.amount}\n`; });
        // Add WORKER Settings
        workerList.forEach(w => { csv += `WORKER,,${w.name},${w.defaultType},,,,0,${w.defaultBankSalary || 0}\n`; });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        const d = new Date();
        const dateStr = `${d.getDate()}-${d.getMonth()+1}-${d.getFullYear()}`;
        link.setAttribute("href", url);
        link.setAttribute("download", `CVD_FullBackup_${dateStr}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }

    // --- SMART IMPORT ---
    function importCSV(input) {
        const f = input.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = e => {
            const lines = e.target.result.split(/\r\n|\n/);
            if(lines.length < 2) return alert("File appears empty.");
            
            const clearFirst = confirm("‚ùì CLEAR DATA FIRST?\n\nClick 'OK' to DELETE current data and import this file.\nClick 'Cancel' to KEEP current data and MERGE this file.");
            
            if(clearFirst) {
                entries = [];
                advances = [];
                bankTransfers = [];
            }

            let counts = { work:0, adv:0, bank:0, worker:0 };

            for(let i=1; i<lines.length; i++) {
                const row = lines[i].trim(); if(!row) continue;
                const c = row.split(",");
                const uID = Date.now() + i + Math.random();
                const type = c[0].toUpperCase().trim();

                if(type === 'WORK') {
                    entries.push({ id:uID, date:c[1], name:c[2], category:c[3], size:parseFloat(c[4]), type:c[5], rate:parseInt(c[6]), qty:parseInt(c[7]), total:parseFloat(c[8]) });
                    counts.work++;
                    
                } else if(type === 'ADVANCE') {
                    // Update check included in save logic, but for raw import we usually just append or merge
                    // Since the user might be restoring a backup, we allow duplicates if they are legitimate history
                    // BUT for our monthly logic, we should probably check if restoring causes overlap.
                    // For simplicity in backup restore, we trust the backup file.
                    advances.push({ id:uID, date:c[1], name:c[2], amount:parseFloat(c[8]) });
                    counts.adv++;
                    
                } else if(type === 'BANK') {
                    const bDate = c[1];
                    const bName = c[2];
                    const bAmt = parseFloat(c[8]) || 0;
                    
                    // Basic merge logic for Bank
                    const existingIndex = bankTransfers.findIndex(b => b.name === bName && b.date === bDate);
                    if (bAmt > 0) {
                        if (existingIndex > -1) { bankTransfers[existingIndex].amount = bAmt; } 
                        else { bankTransfers.push({ id:uID, date:bDate, name:bName, amount:bAmt }); counts.bank++; }
                    }
                } else if(type === 'WORKER') {
                    const idx = workerList.findIndex(w => w.name.toLowerCase() === c[2].toLowerCase());
                    const wData = { name:c[2], defaultType:c[3], defaultBankSalary:parseFloat(c[8])||0 };
                    if(idx > -1) workerList[idx] = wData; else workerList.push(wData);
                    counts.worker++;
                }
            }
            
            saveData(); 
            localStorage.setItem('advanceData', JSON.stringify(advances));
            localStorage.setItem('bankData', JSON.stringify(bankTransfers));
            saveWorkers();
            renderTable(); 
            updateSuggestions();
            input.value = '';
            
            alert(`‚úÖ Restore Complete!\n\nImported (Merged):\n- ${counts.work} Work Entries\n- ${counts.adv} Cash Advances\n- ${counts.bank} Bank Transfers\n- ${counts.worker} Worker Profiles`);
        };
        r.readAsText(f);
    }

    function generateReport() {
        if (!entries.length) { alert("No data!"); return; }
        const s = document.getElementById('startDate').value;
        const e = document.getElementById('endDate').value;
        
        let d = entries;
        let advs = advances; 
        let banks = bankTransfers;
        let tr = "(All Time)";
        
        if (s && e) {
            const d1 = new Date(s); d1.setHours(0,0,0,0); const d2 = new Date(e); d2.setHours(23,59,59,999);
            d = entries.filter(i => { const x = parseDateStr(i.date); return x >= d1 && x <= d2; });
            advs = advances.filter(i => { const x = parseDateStr(i.date); return x >= d1 && x <= d2; });
            banks = bankTransfers.filter(i => { const x = parseDateStr(i.date); return x >= d1 && x <= d2; });
            
            if(!d.length && !advs.length && !banks.length) { alert("No data for this date range"); return; }
            tr = `(${s.split('-').reverse().join('/')} to ${e.split('-').reverse().join('/')})`;
        } else if(s||e) { alert("Select both"); return; }
        
        closeDateModal();
        
        const names = [...new Set([...d.map(i => i.name), ...advs.map(i => i.name), ...banks.map(i => i.name)])];
        
        let h = `<html><head><title>Report</title><style>
            body{font-family:sans-serif;padding:20px}
            h1{text-align:center;border-bottom:2px solid #333}
            table{width:100%;border-collapse:collapse;margin-top:10px;margin-bottom:30px}
            th,td{border:1px solid #ccc;padding:8px;text-align:left;font-size:0.9em}
            th{background:#eee}
            .comm{background-color:#fff9c4 !important;-webkit-print-color-adjust:exact}
            .fancy{background-color:#f8d7da !important;-webkit-print-color-adjust:exact}
        </style></head><body><h1>üíé Salary Report</h1><center>${tr}</center>`;
        
        let gt = 0; 
        
        names.forEach(n => {
            const wData = d.filter(i => i.name === n);
            const wAdv = advs.filter(i => i.name === n);
            const wBank = banks.filter(i => i.name === n);
            
            if (wData.length === 0 && wAdv.length === 0 && wBank.length === 0) return;

            let wt = 0; let wQty = 0; let wSize = 0;
            let wAdvTotal = 0;
            let wBankTotal = 0;
            
            wData.forEach(r => { wt += r.total; wQty += r.qty; wSize += r.size; });
            wAdv.forEach(a => { wAdvTotal += a.amount; });
            wBank.forEach(b => { wBankTotal += b.amount; });
            
            const net = wt - wAdvTotal - wBankTotal;
            gt += net;

            h += `<h3>üë§ ${n}</h3><table><thead><tr><th>Date</th><th>Type</th><th>Size</th><th>Rate</th><th>Qty</th><th>Total</th></tr></thead><tbody>`;
            
            if (wData.length > 0) {
                wData.forEach(r => {
                    let bg = (r.category === 'Commercial') ? 'class="comm"' : (r.category === 'Fancy') ? 'class="fancy"' : '';
                    h += `<tr ${bg}><td>${r.date}</td><td>${r.type}</td><td>${r.size.toFixed(2)}</td><td>${r.rate}</td><td>${r.qty}</td><td>${r.total.toFixed(2)}</td></tr>`;
                });
            } else {
                h += `<tr><td colspan="6" style="text-align:center;font-style:italic">No work entries.</td></tr>`;
            }
            
            h += `</tbody><tfoot>
                <tr><td colspan="2" align="right"><b>Totals:</b></td>
                <td><b>${wSize.toFixed(2)} Cts</b></td> <td align="center">-</td>
                <td><b>${wQty} Pcs</b></td>
                <td><b>‚Çπ${wt.toFixed(2)}</b></td>
            </tr>
                <tr><td colspan="5" align="right" style="color:#d9534f"><b>Less: Cash Advance:</b></td><td style="color:#d9534f"><b>- ‚Çπ${wAdvTotal.toFixed(2)}</b></td></tr>
                <tr><td colspan="5" align="right" style="color:#6f42c1"><b>Less: Bank Transfer:</b></td><td style="color:#6f42c1"><b>- ‚Çπ${wBankTotal.toFixed(2)}</b></td></tr>
                <tr><td colspan="5" align="right" style="font-size:1.1em"><b>Net Payable:</b></td><td style="font-size:1.1em; border-top:2px solid #000; color:${net>=0?'green':'red'}"><b>‚Çπ${net.toFixed(2)}</b></td></tr>
            </tfoot></table>`;
        });
        
        h += `<h2 align="right">Total Net Payable: ‚Çπ${gt.toFixed(2)}</h2><script>window.print()<\/script></body></html>`;
        const w = window.open('', '_blank'); w.document.write(h); w.document.close();
    }
    function parseDateStr(s) { const p=s.split('/'); return new Date(p[2],p[1]-1,p[0]); }
</script>

</body>
</html>
